# Password Authentication Flow

## Phase 1: Login Request

1. User submits username/email and password over HTTPS
2. All authentication pages must be HTTPS-only (prevents credential interception)
3. Rate-limit login attempts per account and per IP
4. Consider CAPTCHA after failed attempt threshold

## Phase 2: Credential Validation

5. Retrieve user record by identifier (username or email)
6. **If user doesn't exist, still perform a dummy hash comparison** (prevents timing attacks)
7. Compare password hash using constant-time comparison function
8. Return generic error for all failure cases: "Invalid username or password"
9. Response time must be consistent regardless of failure reason (user not found vs wrong password)

## Phase 3: Account Protection

10. Track failed login attempts per account
11. Implement account lockout after threshold (e.g., 5 attempts)
    - Lockout duration: fixed (e.g., 15 min) or exponential backoff
    - Lock the account, not the IP (attackers use multiple IPs)
12. **Do not lock account permanently** (enables DoS against known users)
13. Allow password reset even when locked out

## Phase 4: Session Establishment

14. Generate cryptographically random session ID (128+ bits)
15. **Regenerate session ID on successful login** (prevents session fixation)
16. Set session cookie with secure flags:
    - `HttpOnly` (prevents XSS access)
    - `Secure` (HTTPS only)
    - `SameSite=Strict` or `Lax` (CSRF protection)
17. Set appropriate session timeout (idle and absolute)
18. Store session server-side; cookie contains only the session ID

## Phase 5: Post-Authentication

19. Optionally invalidate other active sessions (single-session enforcement)
20. For sensitive operations, require re-authentication (password re-entry)
21. Implement logout that invalidates session server-side (not just cookie deletion)

## Phase 6: Logging & Monitoring

22. Log all authentication events: timestamp, IP, user-agent, success/failure
23. **Never log passwords or password hashes**
24. Alert on anomalies:
    - Multiple failed logins
    - Login from new device/location
    - Impossible travel (logins from distant locations in short time)
25. Notify user of successful login from new device (optional)

---

## Password Storage Requirements

| Requirement | Implementation |
|-------------|----------------|
| Algorithm | Argon2id (preferred), bcrypt, or scrypt |
| Work factor | Tune to ~250ms on your hardware |
| Salt | Unique per password, generated by the algorithm |
| Pepper | Optional application-level secret (stored separately from DB) |
| Max length | Accept at least 64 characters |
| No truncation | Never silently truncate passwords |

## Password Policy

| Rule | NIST SP 800-63B Guidance |
|------|--------------------------|
| Minimum length | 8 chars (with MFA) or 15 chars (without MFA) |
| Maximum length | At least 64 characters |
| Complexity rules | **Do not require** upper/lower/special chars |
| Character types | Allow all printable characters, unicode, spaces |
| Rotation | **Do not require** periodic changes |
| Breach check | Block passwords found in known breaches (e.g., HaveIBeenPwned) |

---

## Key Protections Summary

| Threat | Mitigation |
|--------|------------|
| Credential stuffing | Rate limiting, breach-password blocking, MFA |
| Brute force | Account lockout, rate limiting, CAPTCHA |
| Timing attacks | Constant-time comparison, dummy hash on unknown user |
| User enumeration | Generic error messages, consistent response times |
| Session hijacking | Secure cookie flags, HTTPS only, session regeneration |
| Session fixation | Regenerate session ID on login |
| Password interception | HTTPS only, no password logging |
